#!/usr/bin/env bash
set -uo pipefail

cd "$(dirname "$0")"

usage() {
  cat >&2 <<'USAGE'
Usage: ./compile-all [-j [JOBS]]

Compiles all top-level ESPHome YAML configs in this directory (excluding secrets),
running builds in parallel and saving logs to logs/<name>.log.

  -j [JOBS]   Number of parallel jobs. If omitted or -j is passed without a
              value, uses the number of CPUs on this host.

Examples:
  ./compile-all          # parallel with CPU cores
  ./compile-all -j 4     # parallel with 4 jobs
  ./compile-all -j       # parallel with CPU cores
USAGE
}

default_jobs() {
  if command -v nproc >/dev/null 2>&1; then
    nproc 2>/dev/null || true
    return
  fi
  if command -v sysctl >/dev/null 2>&1; then
    sysctl -n hw.ncpu 2>/dev/null || true
    return
  fi
  echo "Unable to determine CPU count (need 'nproc' or 'sysctl')." >&2
  exit 2
}

# Default to CPU cores unless overridden by -j
JOBS="$(default_jobs)"

while (( "$#" )); do
  case "$1" in
    -j)
      # Optional value: if provided, consume it; otherwise keep default
      if [ $# -ge 2 ] && [[ "$2" != -* ]]; then
        JOBS="$2"; shift 2
      else
        shift
      fi
      ;;
    -j*)
      # Support -j4 form
      JOBS="${1#-j}"; shift ;;
    -h|--help)
      usage; exit 0 ;;
    --)
      shift; break ;;
    -*)
      echo "Unknown option: $1" >&2; usage; exit 2 ;;
    *)
      echo "Unexpected argument: $1" >&2; usage; exit 2 ;;
  esac
done

if ! command -v esphome >/dev/null 2>&1; then
  echo "esphome CLI not found in PATH" >&2
  exit 127
fi

# Warn if secrets are missing
if [ ! -f secrets.yaml ] && [ -f secrets.tmpl ]; then
  echo "Note: secrets.yaml not found; run ./render to generate it" >&2
fi

# Discover top-level YAML configs, excluding secrets templates/files
mapfile -t files < <(
  find . -maxdepth 1 -type f -name '*.yaml' \
    ! -name 'secrets.yaml' \
    ! -name '*secrets*' \
    -print | sort
)

if [ ${#files[@]} -eq 0 ]; then
  echo "No top-level ESPHome YAML configs found." >&2
  exit 0
fi
# Always parallel mode
logs_dir="logs"
mkdir -p "${logs_dir}"
echo "Compiling ${#files[@]} configs with ${JOBS} parallel job(s). Logs in '${logs_dir}/'."

statuses=()

throttle() {
  # Limit number of background jobs
  while :; do
    running=$(jobs -pr | wc -l | tr -d ' ')
    if [ "$running" -lt "$JOBS" ]; then
      break
    fi
    sleep 0.2
  done
}

for f in "${files[@]}"; do
  cfg=${f#./}
  base="${cfg%.yaml}"
  log_file="${logs_dir}/${base}.log"
  status_file="${logs_dir}/${base}.status"
  printf "Queued %s\n" "$cfg"
  throttle
  (
    esphome compile "$cfg" >"$log_file" 2>&1
    rc=$?
    if [ $rc -eq 0 ]; then
      echo OK >"$status_file"
    else
      echo FAIL >"$status_file"
    fi
    exit $rc
  ) &
done

wait || true

echo
echo "Summary:"
fail_count=0
for f in "${files[@]}"; do
  cfg=${f#./}
  base="${cfg%.yaml}"
  status_file="${logs_dir}/${base}.status"
  status="UNKNOWN"
  if [ -f "$status_file" ]; then
    status=$(cat "$status_file" 2>/dev/null || echo UNKNOWN)
  fi
  if [ "$status" = OK ]; then
    printf "  ✅ %s (log: %s)\n" "$cfg" "${logs_dir}/${base}.log"
  else
    printf "  ❌ %s (log: %s)\n" "$cfg" "${logs_dir}/${base}.log"
    fail_count=$((fail_count+1))
  fi
done

exit $([ "$fail_count" -eq 0 ] && echo 0 || echo 1)
