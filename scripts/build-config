#!/usr/bin/ruby

require 'digest'
require 'erb'

KUBE_DIR = ENV['KUBE_CONFIG_DIR'] || "#{ENV['HOME']}/src/infra/kubernetes/hass"
CONFIG_DIR = File.join(__dir__, '..', 'config')

StringIO.open do |f|
  f.puts <<~EOS
    ---
    # This file is generated automatically by the build-config script in the
    # hass-config repo.  Do not edit or check in!
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: hass
    data:
    EOS

  ["*.yaml"].each do |pattern|
    Dir.glob("#{CONFIG_DIR}/#{pattern}").sort.each do |file|
      name = file.sub(CONFIG_DIR + '/', '')
      f.puts "  #{name}: |-"
      data = File.read(file)
      f.puts data.gsub(/^/, "    ")
    end
  end

  File.open("#{KUBE_DIR}/configmap.yaml", "w") do |cmfile|
    cmfile.write(f.string)
  end
end

